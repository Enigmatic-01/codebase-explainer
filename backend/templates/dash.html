<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RepoTalk ‚Äî Chat with Any Repository</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>
<body class="h-screen flex bg-gray-100 text-gray-900 dark:bg-gray-950 dark:text-gray-100 transition-colors" id="body">

  <!-- Mobile Header -->
  <header class="md:hidden fixed top-0 inset-x-0 z-30 flex items-center justify-between bg-white dark:bg-gray-900 text-gray-900 dark:text-white border-b dark:border-gray-800 px-4 h-14">
    <button onclick="toggleSidebar()" class="text-xl">‚ò∞</button>
    <span class="font-semibold truncate text-gray-900 dark:text-gray-100">RepoTalk</span>
    <button onclick="openNewChat()" class="text-sm bg-blue-600 text-white px-3 py-1 rounded">New</button>
  </header>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed md:static inset-y-0 left-0 z-40 w-72 bg-white dark:bg-gray-900 text-gray-900 dark:text-white border-r dark:border-gray-800 flex flex-col p-4 transform -translate-x-full md:translate-x-0 transition-transform">
    <button onclick="openNewChat()" class="mb-3 w-full py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">+ New Chat</button>
    <div id="chatList" class="flex-1 overflow-y-auto space-y-2 text-sm"></div>
    <div class="mt-3 space-y-2">
      <button onclick="toggleTheme()" class="w-full py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">üåô / ‚òÄÔ∏è Theme</button>
      <a  href="/login"  class="w-full py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Authorize</a>
    </div>
  </aside>

  <!-- Sidebar Overlay -->
  <div id="sidebarOverlay" onclick="toggleSidebar()" class="hidden fixed inset-0 bg-black/40 z-30"></div>

  <!-- Main -->
  <main class="flex-1 flex flex-col pt-14 md:pt-0 bg-gray-50 dark:bg-gray-950" id="chatArea">
    <div class="flex-1 flex items-center justify-center px-6" id="welcome">
      <div class="max-w-xl text-center space-y-4">
        <h1 class="text-3xl md:text-4xl font-bold">Understand any repository</h1>
        <p class="text-gray-600 dark:text-gray-400 text-sm md:text-base">Paste a GitHub / GitLab repo URL. Explore README, structure, and chat with AI about <b>what</b>, <b>why</b>, <b>how</b>.</p>
        <div class="flex flex-col md:flex-row items-center justify-center gap-3 mt-4">
          <button onclick="openNewChat()" class="px-5 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Start with a Repo</button>
          <button onclick="toggleTheme()" class="px-5 py-3 rounded-lg bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700">Toggle Theme</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Graph Modal -->
  <div id="graphOverlay" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center">
    <div class="relative w-full h-full md:w-4/5 md:h-4/5 bg-white dark:bg-gray-900 rounded-xl border dark:border-gray-800 shadow-lg">
      <div class="flex items-center justify-between px-4 py-3 border-b dark:border-gray-800">
        <h3 class="font-semibold">Repository Structure</h3>
        <button onclick="closeGraph()" class="text-xl hover:text-red-500">‚úï</button>
      </div>
      <canvas id="graphCanvas" class="w-full h-full"></canvas>
    </div>
  </div>

  <!-- New Chat Modal -->
  <div id="overlay" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-900 rounded-xl p-6 w-full max-w-md mx-4 shadow-xl border dark:border-gray-800">
      <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Start new chat</h2>
      <input id="urlInput" type="url"
  placeholder="Enter repository URL"
  class="w-full border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-lg p-3 mb-3" />

<input id="branchInput" type="text"
  placeholder="Branch (default: main)"
  class="w-full border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-lg p-3 mb-4" />

      <div class="flex gap-3">
        <button onclick="createChat()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Start</button>
        <button onclick="closeNewChat()" class="flex-1 bg-gray-300 dark:bg-gray-700 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
      </div>
    </div>
  </div>
<script>
const USER_ID = "{{ session.get('user')['id'] if session.get('user') else '' }}";
</script>

<script>
/* ---------------- DOM ---------------- */
const body = document.getElementById('body');
const overlay = document.getElementById('overlay');
const chatArea = document.getElementById('chatArea');
const chatList = document.getElementById('chatList');
const welcome = document.getElementById('welcome');
const urlInput = document.getElementById('urlInput');
const branchInput = document.getElementById('branchInput');

const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');

/* ---------------- STATE ---------------- */
let chats = [];
let activeChatId = null;

/* ---------------- API ---------------- */
async function api(path, options = {}) {
  const res = await fetch(path, {
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    ...options
  });

  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

/* ---------------- THEME ---------------- */
function toggleTheme() {
  body.classList.toggle('dark');
}

/* ---------------- SIDEBAR ---------------- */
function toggleSidebar() {
  sidebar.classList.toggle('-translate-x-full');
  sidebarOverlay.classList.toggle('hidden');
}

/* ---------------- MODALS ---------------- */
function openNewChat() {
  overlay.classList.remove('hidden');
}

function closeNewChat() {
  overlay.classList.add('hidden');
  urlInput.value = '';
  branchInput.value = '';
}


/* ---------------- CHAT CRUD ---------------- */
async function loadChats() {
  chats = await api('/api/chats');
  renderSidebar();
}

async function createChat() {
  const url = urlInput.value.trim();
  const branch = branchInput.value.trim() || "main"; // ‚úÖ default

  if (!url) return alert('Enter repo URL');

  const chat = await api('/api/chats', {
    method: 'POST',
    body: JSON.stringify({
      url: url,
      branch: branch        // ‚úÖ correct key + string
    })
  });

  chats.unshift(chat);
  activeChatId = chat.id;
  closeNewChat();
  renderSidebar();
  renderChat();
}


async function openChat(id) {
  activeChatId = id;
  renderSidebar();
  renderChat();
  toggleSidebar();
}

async function deleteChat(id) {
  await api(`/api/chats/${id}`, { method: 'DELETE' });
  chats = chats.filter(c => c.id !== id);
  activeChatId = chats[0]?.id || null;
  renderSidebar();
  renderChat();
}

/* ---------------- RENDER ---------------- */
function renderSidebar() {
  chatList.innerHTML = chats.map(c => `
    <div class="flex gap-1">
      <button onclick="openChat('${c.id}')"
        class="flex-1 text-left px-3 py-2 rounded-lg ${
          c.id === activeChatId ? 'bg-gray-200 dark:bg-gray-700' : 'hover:bg-gray-200 dark:hover:bg-gray-700'
        }">
        ${c.title || c.url}
      </button>
      <button onclick="deleteChat('${c.id}')" class="px-2 text-red-500">‚úï</button>
    </div>
  `).join('');
}

async function renderChat() {
  if (!activeChatId) {
    welcome.classList.remove('hidden');
    return;
  }

  welcome.classList.add('hidden');

  const chat = await api(`/api/chats/${activeChatId}`);

  chatArea.innerHTML = `
    <div class="border-b p-4 font-semibold">${chat.url}</div>

    <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4">
      ${chat.messages.map(m => renderMessage(m.role, m.text)).join('')}
    </div>

    <div class="border-t p-4 flex gap-2">
      <input id="msgInput" class="flex-1 border rounded-lg px-3 py-2" placeholder="Ask about the repo..." />
      <button onclick="sendMessage()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">‚û§</button>
    </div>
  `;
}

function renderMessage(role, text) {
  return `
    <div class="${role === 'ai' ? 'text-left' : 'text-right'}">
      <div class="inline-block px-4 py-2 rounded-lg ${
        role === 'ai'
          ? 'bg-gray-200 dark:bg-gray-800'
          : 'bg-blue-600 text-white'
      }">${text}</div>
    </div>
  `;
}

/* ---------------- SEND MESSAGE + SSE ---------------- */
async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  // 1Ô∏è‚É£ Save user message
  await api(`/api/chats/${activeChatId}/messages`, {
  method: 'POST',
  body: JSON.stringify({ text })
});


  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML += renderMessage('user', text);

  // 2Ô∏è‚É£ AI placeholder
  const aiBubble = document.createElement('div');
  aiBubble.innerHTML = renderMessage('ai', '');
  messagesDiv.appendChild(aiBubble);
  const aiText = aiBubble.querySelector('div > div');

  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  // 3Ô∏è‚É£ Stream AI response
const evtSource = new EventSource(
  `/query?chat_id=${activeChatId}&user_id=${USER_ID}`
);
  evtSource.onmessage = (e) => {
    aiText.innerHTML += e.data;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  };

  evtSource.addEventListener('end', () => {
    evtSource.close();
  });

  evtSource.onerror = () => {
    evtSource.close();
  };
}

/* ---------------- INIT ---------------- */
loadChats();
</script>

</body>
</html>
